{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "13095047128728100730"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "arcServerNames": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minLength": 1,
      "metadata": {
        "description": "Names of the existing Azure Arc-enabled servers in the resource group."
      }
    },
    "azureMonitorWorkspaceName": {
      "type": "string",
      "defaultValue": "amw-vminsights-otel",
      "metadata": {
        "description": "Name of the Azure Monitor Workspace for OTel metrics."
      }
    },
    "dcrName": {
      "type": "string",
      "defaultValue": "[format('MSVMI-otel-{0}', resourceGroup().name)]",
      "metadata": {
        "description": "Name of the Data Collection Rule."
      }
    },
    "samplingFrequencyInSeconds": {
      "type": "int",
      "defaultValue": 60,
      "minValue": 10,
      "maxValue": 300,
      "metadata": {
        "description": "Sampling frequency in seconds for OTel performance counters."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to all resources."
      }
    },
    "enableAdditionalMetrics": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable additional per-process and extended metrics (incurs extra cost)."
      }
    },
    "enableCpuAlert": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable CPU utilization alert rule (requires enableAdditionalMetrics = true)."
      }
    },
    "cpuAlertThreshold": {
      "type": "string",
      "defaultValue": "0.70",
      "metadata": {
        "description": "CPU utilization threshold (0-1). Default 0.70 = 70%."
      }
    },
    "cpuAlertDuration": {
      "type": "string",
      "defaultValue": "PT3M",
      "metadata": {
        "description": "Duration the CPU must exceed threshold before alerting (ISO 8601). Default PT3M = 3 minutes."
      }
    },
    "cpuAlertSeverity": {
      "type": "int",
      "defaultValue": 2,
      "minValue": 0,
      "maxValue": 4,
      "metadata": {
        "description": "Alert severity (0 = Critical, 1 = Error, 2 = Warning, 3 = Informational, 4 = Verbose)."
      }
    },
    "enableMemoryAlert": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable memory utilization alert rule (requires enableAdditionalMetrics = true)."
      }
    },
    "memoryAlertThreshold": {
      "type": "string",
      "defaultValue": "0.90",
      "metadata": {
        "description": "Memory utilization threshold (0-1). Default 0.90 = 90%."
      }
    },
    "memoryAlertDuration": {
      "type": "string",
      "defaultValue": "PT5M",
      "metadata": {
        "description": "Duration memory must exceed threshold before alerting (ISO 8601). Default PT5M = 5 minutes."
      }
    },
    "memoryAlertSeverity": {
      "type": "int",
      "defaultValue": 2,
      "minValue": 0,
      "maxValue": 4,
      "metadata": {
        "description": "Memory alert severity (0 = Critical, 1 = Error, 2 = Warning, 3 = Informational, 4 = Verbose)."
      }
    },
    "enableDiskAlert": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable disk utilization alert rule (requires enableAdditionalMetrics = true)."
      }
    },
    "diskAlertThreshold": {
      "type": "string",
      "defaultValue": "0.90",
      "metadata": {
        "description": "Disk utilization threshold (0-1). Default 0.90 = 90%."
      }
    },
    "diskAlertDuration": {
      "type": "string",
      "defaultValue": "PT5M",
      "metadata": {
        "description": "Duration disk must exceed threshold before alerting (ISO 8601). Default PT5M = 5 minutes."
      }
    },
    "diskAlertSeverity": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "maxValue": 4,
      "metadata": {
        "description": "Disk alert severity (0 = Critical, 1 = Error, 2 = Warning, 3 = Informational, 4 = Verbose)."
      }
    }
  },
  "variables": {
    "defaultCounterSpecifiers": [
      "system.uptime",
      "system.cpu.time",
      "system.memory.usage",
      "system.network.io",
      "system.network.dropped",
      "system.network.errors",
      "system.disk.io",
      "system.disk.operations",
      "system.disk.operation_time",
      "system.filesystem.usage"
    ],
    "additionalCounterSpecifiers": [
      "system.cpu.utilization",
      "system.cpu.logical.count",
      "system.memory.utilization",
      "system.memory.limit",
      "system.filesystem.utilization",
      "system.disk.io_time",
      "system.disk.pending_operations",
      "system.network.packets",
      "system.network.connections",
      "process.uptime",
      "process.cpu.time",
      "process.cpu.utilization",
      "process.memory.usage",
      "process.memory.virtual",
      "process.memory.utilization",
      "process.disk.io",
      "process.disk.operations",
      "process.threads",
      "process.handles"
    ],
    "counterSpecifiers": "[if(parameters('enableAdditionalMetrics'), concat(variables('defaultCounterSpecifiers'), variables('additionalCounterSpecifiers')), variables('defaultCounterSpecifiers'))]"
  },
  "resources": {
    "azureMonitorWorkspace": {
      "type": "Microsoft.Monitor/accounts",
      "apiVersion": "2023-04-03",
      "name": "[parameters('azureMonitorWorkspaceName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    "dataCollectionRule": {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2024-03-11",
      "name": "[parameters('dcrName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "DCR for VM Insights OpenTelemetry metrics on Arc-enabled Windows server",
        "dataSources": {
          "performanceCountersOTel": [
            {
              "name": "OtelDataSource",
              "streams": [
                "Microsoft-OtelPerfMetrics"
              ],
              "samplingFrequencyInSeconds": "[parameters('samplingFrequencyInSeconds')]",
              "counterSpecifiers": "[variables('counterSpecifiers')]"
            }
          ]
        },
        "destinations": {
          "monitoringAccounts": [
            {
              "accountResourceId": "[resourceId('Microsoft.Monitor/accounts', parameters('azureMonitorWorkspaceName'))]",
              "name": "MonitoringAccountDestination"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-OtelPerfMetrics"
            ],
            "destinations": [
              "MonitoringAccountDestination"
            ]
          }
        ]
      },
      "dependsOn": [
        "azureMonitorWorkspace"
      ]
    },
    "arcServers": {
      "copy": {
        "name": "arcServers",
        "count": "[length(parameters('arcServerNames'))]",
        "mode": "serial",
        "batchSize": 5
      },
      "existing": true,
      "type": "Microsoft.HybridCompute/machines",
      "apiVersion": "2024-07-10",
      "name": "[parameters('arcServerNames')[copyIndex()]]"
    },
    "amaExtensions": {
      "copy": {
        "name": "amaExtensions",
        "count": "[length(parameters('arcServerNames'))]"
      },
      "type": "Microsoft.HybridCompute/machines/extensions",
      "apiVersion": "2024-07-10",
      "name": "[format('{0}/{1}', parameters('arcServerNames')[copyIndex()], 'AzureMonitorWindowsAgent')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "publisher": "Microsoft.Azure.Monitor",
        "type": "AzureMonitorWindowsAgent",
        "autoUpgradeMinorVersion": true,
        "enableAutomaticUpgrade": true
      }
    },
    "dcrAssociations": {
      "copy": {
        "name": "dcrAssociations",
        "count": "[length(parameters('arcServerNames'))]"
      },
      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
      "apiVersion": "2024-03-11",
      "scope": "[resourceId('Microsoft.HybridCompute/machines', parameters('arcServerNames')[copyIndex()])]",
      "name": "VMInsightsOTelAssociation",
      "properties": {
        "dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))]",
        "description": "[format('Association of VM Insights OTel DCR with Arc-enabled server {0}', parameters('arcServerNames')[copyIndex()])]"
      },
      "dependsOn": [
        "[format('amaExtensions[{0}]', copyIndex())]",
        "dataCollectionRule"
      ]
    },
    "cpuAlertRuleGroup": {
      "condition": "[and(parameters('enableCpuAlert'), parameters('enableAdditionalMetrics'))]",
      "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
      "apiVersion": "2023-03-01",
      "name": "[format('CPU-High-Utilization-{0}', resourceGroup().name)]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "[format('Alert when CPU utilization exceeds {0} for {1}', parameters('cpuAlertThreshold'), parameters('cpuAlertDuration'))]",
        "enabled": true,
        "interval": "PT1M",
        "scopes": [
          "[resourceId('Microsoft.Monitor/accounts', parameters('azureMonitorWorkspaceName'))]"
        ],
        "rules": [
          {
            "alert": "HighCpuUtilization",
            "expression": "[format('avg by (host_name) (avg_over_time(system_cpu_utilization[3m])) > {0}', parameters('cpuAlertThreshold'))]",
            "for": "[parameters('cpuAlertDuration')]",
            "severity": "[parameters('cpuAlertSeverity')]",
            "enabled": true,
            "annotations": {
              "summary": "High CPU utilization detected",
              "description": "[format('CPU utilization on {{{{ $labels.host_name }}}} has been above {0} for more than {1}', parameters('cpuAlertThreshold'), parameters('cpuAlertDuration'))]"
            },
            "labels": {
              "source": "vminsights-otel",
              "resourceGroup": "[resourceGroup().name]"
            },
            "resolveConfiguration": {
              "autoResolved": true,
              "timeToResolve": "PT5M"
            }
          }
        ]
      },
      "dependsOn": [
        "azureMonitorWorkspace"
      ]
    },
    "memoryAlertRuleGroup": {
      "condition": "[and(parameters('enableMemoryAlert'), parameters('enableAdditionalMetrics'))]",
      "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
      "apiVersion": "2023-03-01",
      "name": "[format('Memory-High-Utilization-{0}', resourceGroup().name)]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "[format('Alert when memory utilization exceeds {0} for {1}', parameters('memoryAlertThreshold'), parameters('memoryAlertDuration'))]",
        "enabled": true,
        "interval": "PT1M",
        "scopes": [
          "[resourceId('Microsoft.Monitor/accounts', parameters('azureMonitorWorkspaceName'))]"
        ],
        "rules": [
          {
            "alert": "HighMemoryUtilization",
            "expression": "[format('avg by (host_name) (avg_over_time(system_memory_utilization[5m])) > {0}', parameters('memoryAlertThreshold'))]",
            "for": "[parameters('memoryAlertDuration')]",
            "severity": "[parameters('memoryAlertSeverity')]",
            "enabled": true,
            "annotations": {
              "summary": "High memory utilization detected",
              "description": "[format('Memory utilization on {{{{ $labels.host_name }}}} has been above {0} for more than {1}', parameters('memoryAlertThreshold'), parameters('memoryAlertDuration'))]"
            },
            "labels": {
              "source": "vminsights-otel",
              "resourceGroup": "[resourceGroup().name]"
            },
            "resolveConfiguration": {
              "autoResolved": true,
              "timeToResolve": "PT5M"
            }
          }
        ]
      },
      "dependsOn": [
        "azureMonitorWorkspace"
      ]
    },
    "diskAlertRuleGroup": {
      "condition": "[and(parameters('enableDiskAlert'), parameters('enableAdditionalMetrics'))]",
      "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
      "apiVersion": "2023-03-01",
      "name": "[format('Disk-High-Utilization-{0}', resourceGroup().name)]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "[format('Alert when logical disk utilization exceeds {0} for {1}', parameters('diskAlertThreshold'), parameters('diskAlertDuration'))]",
        "enabled": true,
        "interval": "PT1M",
        "scopes": [
          "[resourceId('Microsoft.Monitor/accounts', parameters('azureMonitorWorkspaceName'))]"
        ],
        "rules": [
          {
            "alert": "HighDiskUtilization",
            "expression": "[format('max by (host_name, mountpoint) (avg_over_time(system_filesystem_utilization[5m])) > {0}', parameters('diskAlertThreshold'))]",
            "for": "[parameters('diskAlertDuration')]",
            "severity": "[parameters('diskAlertSeverity')]",
            "enabled": true,
            "annotations": {
              "summary": "High disk utilization detected",
              "description": "[format('Disk utilization on {{{{ $labels.host_name }}}} mount {{{{ $labels.mountpoint }}}} has been above {0} for more than {1}', parameters('diskAlertThreshold'), parameters('diskAlertDuration'))]"
            },
            "labels": {
              "source": "vminsights-otel",
              "resourceGroup": "[resourceGroup().name]"
            },
            "resolveConfiguration": {
              "autoResolved": true,
              "timeToResolve": "PT10M"
            }
          }
        ]
      },
      "dependsOn": [
        "azureMonitorWorkspace"
      ]
    }
  },
  "outputs": {
    "azureMonitorWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the Azure Monitor Workspace."
      },
      "value": "[resourceId('Microsoft.Monitor/accounts', parameters('azureMonitorWorkspaceName'))]"
    },
    "dataCollectionRuleId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the Data Collection Rule."
      },
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))]"
    },
    "configuredServers": {
      "type": "array",
      "metadata": {
        "description": "Names of Arc servers configured."
      },
      "value": "[parameters('arcServerNames')]"
    }
  }
}